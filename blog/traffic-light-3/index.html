<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Smart Traffic Light 3: Full version | Jos Zuijderwijk </title> <meta name="author" content="Jos Zuijderwijk"> <meta name="description" content="Building a Full-Size Smart Traffic Light."> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?c754f1480f70868e3d1156aa95244266"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://joszuijderwijk.nl/blog/traffic-light-3/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">
      {
            "title": "Smart Traffic Light 3: Full version",
            "description": "Building a Full-Size Smart Traffic Light.",
            "published": "March 16, 2021",
            "authors": [
              
            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Jos</span> Zuijderwijk </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/contact/">Contact </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Smart Traffic Light 3: Full version</h1> <p>Building a Full-Size Smart Traffic Light.</p> </d-title> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div> <a href="#hardware">Hardware</a> </div> <ul> <li> <a href="#components">Components</a> </li> <li> <a href="#controlling-the-lights">Controlling the Lights</a> </li> <li> <a href="#controller">Controller</a> </li> <li> <a href="#the-lights">The Lights</a> </li> </ul> <div> <a href="#software">Software</a> </div> <ul> <li> <a href="#animations">Animations</a> </li> <li> <a href="#manual-control">Manual control</a> </li> <li> <a href="#remote-control">Remote control</a> </li> <li> <a href="#ota-updates">OTA Updates</a> </li> </ul> <div> <a href="#result">Result</a> </div> </nav> </d-contents> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/full-traffic-light-header-480.webp 480w,/assets/img/full-traffic-light-header-800.webp 800w,/assets/img/full-traffic-light-header-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/full-traffic-light-header.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><a href="https://github.com/joszuijderwijk/smart-traffic-light" rel="external nofollow noopener" target="_blank"><img src="https://img.shields.io/badge/github%20-%20smart--traffic--light-blue?logo=github" alt="Static Badge"></a> <img src="https://img.shields.io/github/stars/joszuijderwijk/smart-traffic-light" alt="Static Badge"></p> <p>We’ve previously set up an <a href="traffic-light-1">IoT Framework</a> and created a <a href="traffic-light-3">prototype traffic light</a>. Now, let’s take it to the next level by building a full-size traffic light that displays our rowing club’s current rowing ban status. This upgraded version will feature:</p> <ul> <li>Various animations, including a party mode</li> <li>Web app control</li> <li>Manual control via a physical button</li> </ul> <details> <summary>Manual (Dutch)</summary> <p>De handleiding voor Orca vind je <a href="../../assets/files/stoplicht-handleiding_gelakt.pdf">hier</a>.</p> </details> <h2 id="hardware">Hardware</h2> <h3 id="components">Components</h3> <p>For this project, we’ll need:</p> <ul> <li>1x Full-size traffic light</li> <li>1x <a href="https://nl.aliexpress.com/item/4000055280006.html" rel="external nofollow noopener" target="_blank">NodeMCU V3</a> (or similar)</li> <li>3x <a href="https://nl.aliexpress.com/item/4000956019162.html" rel="external nofollow noopener" target="_blank">Relay modules</a> </li> <li>1x <a href="https://nl.aliexpress.com/item/33022245121.html" rel="external nofollow noopener" target="_blank">HLK-PM01 AC-DC Power supply</a> </li> <li>1x Push button</li> <li>1x Power switch</li> <li>1x Junction box</li> <li>Installation wire</li> </ul> <p>I bought a full size traffic light via <a href="https://www.marktplaats.nl/" rel="external nofollow noopener" target="_blank">Marktplaats</a> (similar to Ebay) for €110. After swapping out the old bulbs for LEDs, it was ready for its smart makeover.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/full-traffic-light-1-480.webp 480w,/assets/img/full-traffic-light-1-800.webp 800w,/assets/img/full-traffic-light-1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/full-traffic-light-1.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/full-traffic-light-2-480.webp 480w,/assets/img/full-traffic-light-2-800.webp 800w,/assets/img/full-traffic-light-2-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/full-traffic-light-2.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Figure 1: The Traffic Light </div> <h3 id="controlling-the-lights">Controlling the Lights</h3> <p>You’ll probably find that the lights of your traffic light are wired in such a way that all lights turn on when you give it power. To be able to have some control over the individual lights instead of them all turning on at once, we’ll use a microcontroller (NodeMCU) and relay modules. It’s all very similar to the way we designed our <a href="smart-traffic-light-2">prototype</a>, although instead of addressing our LEDs directly, we’ll be using a relay.</p> <p>The relay module we use accepts an input (0V LOW - 5V HIGH) that is sent by our microcontroller. If you pull the input pin (<strong>IN</strong>) high, the terminals <strong>NO</strong> (normaly open) and <strong>COM</strong> (common) will be connected, while <strong>COM</strong> and <strong>NC</strong> (normally closed) will be connected if the input pin is low. The labels on the PCB might be in Chinese (see Figure 2) so make sure you use a multimeter to check the terminals.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/relay-480.webp 480w,/assets/img/relay-800.webp 800w,/assets/img/relay-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/relay.png" class="img-fluid small-img rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Figure 2: The Relay Module. </div> <p>We connected everything according to the wiring diagram below (that includes the power switch and control button). This setup gives us fine-grained control over each light. The microcontroller gets its 5V from the HiLink supply.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/Schematic_Stoplicht-2_2021-02-20-1.svg-480.webp 480w,/assets/img/Schematic_Stoplicht-2_2021-02-20-1.svg-800.webp 800w,/assets/img/Schematic_Stoplicht-2_2021-02-20-1.svg-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/Schematic_Stoplicht-2_2021-02-20-1.svg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Figure 3: The Wiring Diagram. </div> <h3 id="controller">Controller</h3> <p>I wanted to have the NodeMCU and the relay boards all on one perf board. But the male header pins of the relay boards faced upwards so I desoldered them and reinstalled them the other way around.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <video src="/assets/video/relay-loose-connection.mp4" class="img-fluid small-img rounded z-depth-1" width="auto" height="auto" controls=""></video> </figure> </div> </div> <div class="caption"> Video 1: Loose connections on the relay module </div> <p>That didn’t go well… The new pins didn’t work and I practically ruined all of my relay boards. Since I didn’t want to wait for new ones, I decided to get rid of all of the control logic on the module and recreate it myself. For that purpose I used a standard BC547 transistor with a 1K ohm resistor and a 1N4007 flyback diode.</p> <p>I made it unnecessarily difficult for myself in the first place by insisting on placing all the components on one board. It’s a whole lot easier to just glue the relay boards directly into the junction box. But I couldn’t go back as I hadn’t any spare parts laying around, so I glued the relay components to the board. The final result looked like this:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/relays-wired-up-1-480.webp 480w,/assets/img/relays-wired-up-1-800.webp 800w,/assets/img/relays-wired-up-1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/relays-wired-up-1.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/relays-wired-up-2-480.webp 480w,/assets/img/relays-wired-up-2-800.webp 800w,/assets/img/relays-wired-up-2-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/relays-wired-up-2.jpg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Figure 4: The relay boards are wired up </div> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <video src="/assets/video/testing-the-circuit.mp4" class="img-fluid small-img rounded z-depth-1" width="auto" height="auto" controls=""></video> </figure> </div> </div> <div class="caption"> Video 2: Testing the circuit </div> <p>The push button is connected to a GPIO and GND. Using the internal pull-up (this is done in code) we can detect whether the button is pressed.</p> <h3 id="the-lights">The Lights</h3> <p>With the controller sorted, my friend Marte wired up the lights according to our schematic. We then carefully inserted the microcontroller into the junction box. It was a tight fit, but we managed to connect all the wires.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/inside-1-480.webp 480w,/assets/img/inside-1-800.webp 800w,/assets/img/inside-1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/inside-1.jpeg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/inside-2-480.webp 480w,/assets/img/inside-2-800.webp 800w,/assets/img/inside-2-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/inside-2.jpeg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Figure 5: All of the electonics inside the traffic light </div> <p>As you can see, the Hi-Link AC-DC module is placed outside of the box (with the use of some good ol’ duct tape). This is definitely not the ideal way to attach the module to the case, but the traffic light is not intended for outdoor use anyway.</p> <p>Aaaaaaaaand it works! Admittedly not after one try… I accidently swapped the green and the red light, so I had to fix that programmatically.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <video src="/assets/video/testing-the-light.mp4" class="img-fluid small-img rounded z-depth-1" width="auto" height="auto" controls=""></video> </figure> </div> </div> <div class="caption"> Video 3: It works </div> <h2 id="software">Software</h2> <p>Now we got the hardware part out of the way, we still needed software to drive the traffic light.</p> <p>The traffic light has the following features:</p> <ul> <li>Current rowing ban display (<em>rowing ban mode</em>)</li> <li>Various animations</li> <li>Manual and remote control</li> <li>Over-the-air (OTA) firmware updates</li> <li>WiFi configuration via WiFiManager</li> <li>Time-based on/off scheduling</li> <li>Toggle green light to save energy</li> </ul> <p>I already discussed and implemented some of these feature in the prototype (MQTT connection, WiFi manager, some animations). In this post I’ll focus on the new features.</p> <div class="alert alert-primary" role="alert"> <p><i class="fab fa-github fa-xl"></i> The full source code for driving the traffic light is available on <a href="https://github.com/joszuijderwijk/smart-traffic-light/blob/main/stoplicht.ino" rel="external nofollow noopener" target="_blank">GitHub</a>.</p> </div> <h3 id="animations">Animations</h3> <p>Since the traffic light is placed inside, I wanted to add animation effects so that it could be used while partying or as a decorative light. I included the following animations:</p> <ul> <li>Party mode (flashy animation)</li> <li>Random mode (lights turn on/off randomly)</li> <li>Off mode (all lights off)</li> <li>On mode (all lights on)</li> </ul> <p>I implemented the animations as a nested array of booleans, each representing the state of one light. Here’s a snippet of how I implemented the random animation:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">randomAnimation</span><span class="p">(){</span>
  <span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">setLights</span><span class="p">(</span><span class="n">r</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">r</span> <span class="o">%</span> <span class="mi">3</span><span class="p">,</span> <span class="n">r</span> <span class="o">%</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>Note that in the implementation above at least one light is always on.</p> <h3 id="manual-control">Manual control</h3> <p>A big red push button on the side allows users to interact with the traffic light:</p> <ul> <li>Short press: Toggles the green light in ‘rowing ban mode’</li> <li>Long press: Enters ‘animation mode’, allowing users to cycle through animations.</li> </ul> <h3 id="remote-control">Remote control</h3> <p>I built a simple dashboard using Node-RED for remote access and added a timer function for scheduling. It’s generally a good idea to make your devices modular to allow for future expansion of functionality.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/traffic-light-dashboard-480.webp 480w,/assets/img/traffic-light-dashboard-800.webp 800w,/assets/img/traffic-light-dashboard-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/traffic-light-dashboard.png" class="img-fluid small-img rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Figure 6: Dashboard </div> <h3 id="ota-updates">OTA Updates</h3> <p>Taking apart the whole thing for a software update is a very tedious task. Luckily we have Over The Air (OTA) updates. This practically means that you can upload new firmware through WiFi to your microcontroller.</p> <p>For that purpose, I used <a href="https://flows.nodered.org/flow/888b4cd95250197eb429b2f40d188185" rel="external nofollow noopener" target="_blank">this Node-RED flow</a> (modified) together with <a href="https://github.com/esp8266/Arduino/blob/master/libraries/ESP8266httpUpdate/src/ESP8266httpUpdate.h" rel="external nofollow noopener" target="_blank">this library</a>. The latter makes it possible to send a HTTP request to an update server (our Node-RED server!) to ask whether an update is available. It sends its current firmware version that is hardcoded. If the server version is higher, the server will respond with the firmware update. Note that the <a href="https://github.com/espressif/arduino-esp32/tree/master/libraries/WiFiClientSecure" rel="external nofollow noopener" target="_blank">WiFiClientSecure</a> library is needed when requesting updates from a HTTPS server.</p> <p>Now, to be able to update OTA, you have to trigger the update check. I added an MQTT topic (<code class="language-plaintext highlighter-rouge">vvb/update</code>) that leads to the device checking for updates whenever a message is sent to it.</p> <p>I added the logic for checking the right name of the firmware and the MQTT topic that serves as the update topic (this could also be achieved by specifying the firmware name into a single, defined update topic). This makes it possible to update multiple devices running different firmware. Note that it is also possible to update multiple devices running the same firmware. The JSON file below is an example of a configuration file that I use for the OTA system.</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
   </span><span class="nl">"settings"</span><span class="p">:[</span><span class="w">
      </span><span class="p">{</span><span class="w">
         </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"stoplicht"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"topic"</span><span class="p">:</span><span class="s2">"vvb/update"</span><span class="p">,</span><span class="w">
         </span><span class="nl">"latest"</span><span class="p">:{</span><span class="w">
            </span><span class="nl">"version"</span><span class="p">:</span><span class="s2">"1.0"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"file"</span><span class="p">:</span><span class="s2">"/data/firmware/stoplicht/stoplicht_1.0.bin"</span><span class="w">
         </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
   </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div> <p>So, if you want to roll out a firmware update, it’s as easy as doing the following steps:</p> <ol> <li>Compile the source code to a .bin file</li> <li>Upload the .bin file to the destined folder on your server</li> <li>Edit the JSON file and also upload it to your server</li> <li>Trigger the updater of the traffic light</li> </ol> <p>Steps 2 and 3 could be automated by adding a file uploader to the update system. The full flow is included below.</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"e9377d19.816dc"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"http in"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Receive Update Request"</span><span class="p">,</span><span class="nl">"url"</span><span class="p">:</span><span class="s2">"update"</span><span class="p">,</span><span class="nl">"method"</span><span class="p">:</span><span class="s2">"get"</span><span class="p">,</span><span class="nl">"upload"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"swaggerDoc"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">130</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">320</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"8551578f.8af5d8"</span><span class="p">,</span><span class="s2">"a1ae8f2d.f63a1"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"30fd7c07.857824"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"mqtt out"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Update message"</span><span class="p">,</span><span class="nl">"topic"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"qos"</span><span class="p">:</span><span class="s2">"1"</span><span class="p">,</span><span class="nl">"retain"</span><span class="p">:</span><span class="s2">"true"</span><span class="p">,</span><span class="nl">"broker"</span><span class="p">:</span><span class="s2">"e7ca3249.6ee4f"</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">1070</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"44277341.eff32c"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"inject"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Trigger update"</span><span class="p">,</span><span class="nl">"props"</span><span class="p">:[{</span><span class="nl">"p"</span><span class="p">:</span><span class="s2">"name"</span><span class="p">,</span><span class="nl">"v"</span><span class="p">:</span><span class="s2">"stoplicht"</span><span class="p">,</span><span class="nl">"vt"</span><span class="p">:</span><span class="s2">"str"</span><span class="p">}],</span><span class="nl">"repeat"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"crontab"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"once"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"onceDelay"</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span><span class="nl">"topic"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">120</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">160</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"eb57067c.d5d248"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"8551578f.8af5d8"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"switch"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Check user agent"</span><span class="p">,</span><span class="nl">"property"</span><span class="p">:</span><span class="s2">"req.headers.user-agent"</span><span class="p">,</span><span class="nl">"propertyType"</span><span class="p">:</span><span class="s2">"msg"</span><span class="p">,</span><span class="nl">"rules"</span><span class="p">:[{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"neq"</span><span class="p">,</span><span class="nl">"v"</span><span class="p">:</span><span class="s2">"ESP8266-http-Update"</span><span class="p">,</span><span class="nl">"vt"</span><span class="p">:</span><span class="s2">"str"</span><span class="p">},{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"else"</span><span class="p">}],</span><span class="nl">"checkall"</span><span class="p">:</span><span class="s2">"false"</span><span class="p">,</span><span class="nl">"repair"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"outputs"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">390</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">320</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"68f30d59.fc2a84"</span><span class="p">],[</span><span class="s2">"ff42fb92.516148"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"68f30d59.fc2a84"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"change"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Forbidden"</span><span class="p">,</span><span class="nl">"rules"</span><span class="p">:[{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"set"</span><span class="p">,</span><span class="nl">"p"</span><span class="p">:</span><span class="s2">"statusCode"</span><span class="p">,</span><span class="nl">"pt"</span><span class="p">:</span><span class="s2">"msg"</span><span class="p">,</span><span class="nl">"to"</span><span class="p">:</span><span class="s2">"403"</span><span class="p">,</span><span class="nl">"tot"</span><span class="p">:</span><span class="s2">"str"</span><span class="p">},{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"set"</span><span class="p">,</span><span class="nl">"p"</span><span class="p">:</span><span class="s2">"payload"</span><span class="p">,</span><span class="nl">"pt"</span><span class="p">:</span><span class="s2">"msg"</span><span class="p">,</span><span class="nl">"to"</span><span class="p">:</span><span class="s2">"Forbidden"</span><span class="p">,</span><span class="nl">"tot"</span><span class="p">:</span><span class="s2">"str"</span><span class="p">}],</span><span class="nl">"action"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"property"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"from"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"to"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"reg"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">1040</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">320</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"132eb487.bc16fb"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"132eb487.bc16fb"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"http response"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Response"</span><span class="p">,</span><span class="nl">"statusCode"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"headers"</span><span class="p">:{},</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">1340</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">360</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"ee2df76.ef08808"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"change"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"No Update"</span><span class="p">,</span><span class="nl">"rules"</span><span class="p">:[{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"set"</span><span class="p">,</span><span class="nl">"p"</span><span class="p">:</span><span class="s2">"statusCode"</span><span class="p">,</span><span class="nl">"pt"</span><span class="p">:</span><span class="s2">"msg"</span><span class="p">,</span><span class="nl">"to"</span><span class="p">:</span><span class="s2">"304"</span><span class="p">,</span><span class="nl">"tot"</span><span class="p">:</span><span class="s2">"str"</span><span class="p">}],</span><span class="nl">"action"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"property"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"from"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"to"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"reg"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">1050</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">360</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"132eb487.bc16fb"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"9894e289.9dab4"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"file in"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Load Firmware"</span><span class="p">,</span><span class="nl">"filename"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"format"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"sendError"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">500</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"b4cc75ad.14d338"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"70aba325.bf515c"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"catch"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"File error"</span><span class="p">,</span><span class="nl">"scope"</span><span class="p">:[</span><span class="s2">"9894e289.9dab4"</span><span class="p">],</span><span class="nl">"uncaught"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">1040</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">420</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"1b28cf87.fcf9e"</span><span class="p">,</span><span class="s2">"ee2df76.ef08808"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"1b28cf87.fcf9e"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"debug"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Firmware file error"</span><span class="p">,</span><span class="nl">"active"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nl">"tosidebar"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nl">"console"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"tostatus"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"complete"</span><span class="p">:</span><span class="s2">"error"</span><span class="p">,</span><span class="nl">"targetType"</span><span class="p">:</span><span class="s2">"msg"</span><span class="p">,</span><span class="nl">"statusVal"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"statusType"</span><span class="p">:</span><span class="s2">"auto"</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">1370</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">440</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"ff42fb92.516148"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"file in"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Load settings"</span><span class="p">,</span><span class="nl">"filename"</span><span class="p">:</span><span class="s2">"/data/firmware/settings.json"</span><span class="p">,</span><span class="nl">"format"</span><span class="p">:</span><span class="s2">"utf8"</span><span class="p">,</span><span class="nl">"sendError"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">490</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">400</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"d019f6b2.34a7a8"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"d019f6b2.34a7a8"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"json"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"property"</span><span class="p">:</span><span class="s2">"payload"</span><span class="p">,</span><span class="nl">"action"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"pretty"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">630</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">400</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"452789ce.c201f8"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"eb57067c.d5d248"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"file in"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Load settings"</span><span class="p">,</span><span class="nl">"filename"</span><span class="p">:</span><span class="s2">"/data/firmware/settings.json"</span><span class="p">,</span><span class="nl">"format"</span><span class="p">:</span><span class="s2">"utf8"</span><span class="p">,</span><span class="nl">"sendError"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">290</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">160</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"a0ecf9f0.626ef8"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"a0ecf9f0.626ef8"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"json"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"property"</span><span class="p">:</span><span class="s2">"payload"</span><span class="p">,</span><span class="nl">"action"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"pretty"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">430</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">160</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"e165242f.f922f8"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"8f069645.1a3b58"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"comment"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"info"</span><span class="p">:</span><span class="s2">"Vergeet niet in te stellen welke firmware er moet worden geüpdatet!</span><span class="se">\n\n</span><span class="s2">Neem bij vragen contact op met [Jos Zuijderwijk](mailto:hoi@joszuijderwijk.nl)."</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">110</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">120</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"e165242f.f922f8"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"function"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"find fw data"</span><span class="p">,</span><span class="nl">"func"</span><span class="p">:</span><span class="s2">"for (var i in msg.payload.settings){</span><span class="se">\n</span><span class="s2"> var item = msg.payload.settings[i]</span><span class="se">\n</span><span class="s2"> if (item.name == msg.name){</span><span class="se">\n</span><span class="s2"> msg.payload = item;</span><span class="se">\n</span><span class="s2"> return msg;</span><span class="se">\n</span><span class="s2"> }</span><span class="se">\n</span><span class="s2">}</span><span class="se">\n\n</span><span class="s2">// not found! error</span><span class="se">\n</span><span class="s2">msg.payload = </span><span class="se">\"</span><span class="s2">404</span><span class="se">\"</span><span class="s2">;</span><span class="se">\n</span><span class="s2">return msg;"</span><span class="p">,</span><span class="nl">"outputs"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"noerr"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"initialize"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"finalize"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">590</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">160</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"f1531d6a.0657d"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"f1531d6a.0657d"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"switch"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"found?"</span><span class="p">,</span><span class="nl">"property"</span><span class="p">:</span><span class="s2">"payload"</span><span class="p">,</span><span class="nl">"propertyType"</span><span class="p">:</span><span class="s2">"msg"</span><span class="p">,</span><span class="nl">"rules"</span><span class="p">:[{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"eq"</span><span class="p">,</span><span class="nl">"v"</span><span class="p">:</span><span class="s2">"404"</span><span class="p">,</span><span class="nl">"vt"</span><span class="p">:</span><span class="s2">"str"</span><span class="p">},{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"else"</span><span class="p">}],</span><span class="nl">"checkall"</span><span class="p">:</span><span class="s2">"true"</span><span class="p">,</span><span class="nl">"repair"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"outputs"</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">730</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">160</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"cc91223e.9aec2"</span><span class="p">],[</span><span class="s2">"baa0a8e0.734d98"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"cc91223e.9aec2"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"debug"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Not found!"</span><span class="p">,</span><span class="nl">"active"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"tosidebar"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nl">"console"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"tostatus"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"complete"</span><span class="p">:</span><span class="s2">"true"</span><span class="p">,</span><span class="nl">"targetType"</span><span class="p">:</span><span class="s2">"full"</span><span class="p">,</span><span class="nl">"statusVal"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"statusType"</span><span class="p">:</span><span class="s2">"auto"</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">890</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">120</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"baa0a8e0.734d98"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"change"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"rules"</span><span class="p">:[{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"set"</span><span class="p">,</span><span class="nl">"p"</span><span class="p">:</span><span class="s2">"topic"</span><span class="p">,</span><span class="nl">"pt"</span><span class="p">:</span><span class="s2">"msg"</span><span class="p">,</span><span class="nl">"to"</span><span class="p">:</span><span class="s2">"payload.topic"</span><span class="p">,</span><span class="nl">"tot"</span><span class="p">:</span><span class="s2">"msg"</span><span class="p">},{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"set"</span><span class="p">,</span><span class="nl">"p"</span><span class="p">:</span><span class="s2">"payload"</span><span class="p">,</span><span class="nl">"pt"</span><span class="p">:</span><span class="s2">"msg"</span><span class="p">,</span><span class="nl">"to"</span><span class="p">:</span><span class="s2">"payload.latest.version"</span><span class="p">,</span><span class="nl">"tot"</span><span class="p">:</span><span class="s2">"msg"</span><span class="p">}],</span><span class="nl">"action"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"property"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"from"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"to"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"reg"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">880</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">200</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"30fd7c07.857824"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"452789ce.c201f8"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"function"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"check fw data"</span><span class="p">,</span><span class="nl">"func"</span><span class="p">:</span><span class="s2">"var fw = JSON.parse(msg.req.headers[</span><span class="se">\"</span><span class="s2">x-esp8266-version</span><span class="se">\"</span><span class="s2">]);</span><span class="se">\n\n</span><span class="s2">for (var i in msg.payload.settings){</span><span class="se">\n</span><span class="s2"> var item = msg.payload.settings[i]</span><span class="se">\n</span><span class="s2"> if (item.name == fw.name){</span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="s2"> //check version</span><span class="se">\n</span><span class="s2"> if (item.version == fw.version){</span><span class="se">\n</span><span class="s2"> msg.payload = </span><span class="se">\"</span><span class="s2">304</span><span class="se">\"</span><span class="s2">;</span><span class="se">\n</span><span class="s2"> return msg;</span><span class="se">\n</span><span class="s2"> }else{</span><span class="se">\n</span><span class="s2"> msg.filename = item.latest.file;</span><span class="se">\n</span><span class="s2"> msg.req = fw;</span><span class="se">\n</span><span class="s2"> return msg;</span><span class="se">\n</span><span class="s2"> }</span><span class="se">\n\n</span><span class="s2"> }</span><span class="se">\n</span><span class="s2">}</span><span class="se">\n\n</span><span class="s2">// not found! error</span><span class="se">\n</span><span class="s2">msg.payload = </span><span class="se">\"</span><span class="s2">404</span><span class="se">\"</span><span class="s2">;</span><span class="se">\n</span><span class="s2">return msg;"</span><span class="p">,</span><span class="nl">"outputs"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"noerr"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"initialize"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"finalize"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">620</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">460</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"6664c2.0ab02b4"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"6664c2.0ab02b4"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"switch"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"check version"</span><span class="p">,</span><span class="nl">"property"</span><span class="p">:</span><span class="s2">"payload"</span><span class="p">,</span><span class="nl">"propertyType"</span><span class="p">:</span><span class="s2">"msg"</span><span class="p">,</span><span class="nl">"rules"</span><span class="p">:[{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"eq"</span><span class="p">,</span><span class="nl">"v"</span><span class="p">:</span><span class="s2">"404"</span><span class="p">,</span><span class="nl">"vt"</span><span class="p">:</span><span class="s2">"str"</span><span class="p">},{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"eq"</span><span class="p">,</span><span class="nl">"v"</span><span class="p">:</span><span class="s2">"304"</span><span class="p">,</span><span class="nl">"vt"</span><span class="p">:</span><span class="s2">"str"</span><span class="p">},{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"else"</span><span class="p">}],</span><span class="nl">"checkall"</span><span class="p">:</span><span class="s2">"true"</span><span class="p">,</span><span class="nl">"repair"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"outputs"</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">840</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">400</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"ee2df76.ef08808"</span><span class="p">],[</span><span class="s2">"ee2df76.ef08808"</span><span class="p">],[</span><span class="s2">"9894e289.9dab4"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"b4cc75ad.14d338"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"change"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Update!"</span><span class="p">,</span><span class="nl">"rules"</span><span class="p">:[{</span><span class="nl">"t"</span><span class="p">:</span><span class="s2">"set"</span><span class="p">,</span><span class="nl">"p"</span><span class="p">:</span><span class="s2">"statusCode"</span><span class="p">,</span><span class="nl">"pt"</span><span class="p">:</span><span class="s2">"msg"</span><span class="p">,</span><span class="nl">"to"</span><span class="p">:</span><span class="s2">"200"</span><span class="p">,</span><span class="nl">"tot"</span><span class="p">:</span><span class="s2">"str"</span><span class="p">}],</span><span class="nl">"action"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"property"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"from"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"to"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"reg"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">1160</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">500</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[[</span><span class="s2">"132eb487.bc16fb"</span><span class="p">]]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"a1ae8f2d.f63a1"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"debug"</span><span class="p">,</span><span class="nl">"z"</span><span class="p">:</span><span class="s2">"f6336577.1bc9f8"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"active"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nl">"tosidebar"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nl">"console"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"tostatus"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"complete"</span><span class="p">:</span><span class="s2">"true"</span><span class="p">,</span><span class="nl">"targetType"</span><span class="p">:</span><span class="s2">"full"</span><span class="p">,</span><span class="nl">"statusVal"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"statusType"</span><span class="p">:</span><span class="s2">"auto"</span><span class="p">,</span><span class="nl">"x"</span><span class="p">:</span><span class="mi">340</span><span class="p">,</span><span class="nl">"y"</span><span class="p">:</span><span class="mi">260</span><span class="p">,</span><span class="nl">"wires"</span><span class="p">:[]},{</span><span class="nl">"id"</span><span class="p">:</span><span class="s2">"e7ca3249.6ee4f"</span><span class="p">,</span><span class="nl">"type"</span><span class="p">:</span><span class="s2">"mqtt-broker"</span><span class="p">,</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"Orca Broker"</span><span class="p">,</span><span class="nl">"broker"</span><span class="p">:</span><span class="s2">"mqtt.orcaroeien.nl"</span><span class="p">,</span><span class="nl">"port"</span><span class="p">:</span><span class="s2">"1883"</span><span class="p">,</span><span class="nl">"clientid"</span><span class="p">:</span><span class="s2">"Orca IOT"</span><span class="p">,</span><span class="nl">"usetls"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"compatmode"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="nl">"keepalive"</span><span class="p">:</span><span class="s2">"60"</span><span class="p">,</span><span class="nl">"cleansession"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="nl">"birthTopic"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"birthQos"</span><span class="p">:</span><span class="s2">"0"</span><span class="p">,</span><span class="nl">"birthPayload"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"closeTopic"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"closeQos"</span><span class="p">:</span><span class="s2">"0"</span><span class="p">,</span><span class="nl">"closePayload"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"willTopic"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="nl">"willQos"</span><span class="p">:</span><span class="s2">"0"</span><span class="p">,</span><span class="nl">"willPayload"</span><span class="p">:</span><span class="s2">""</span><span class="p">}]</span><span class="w">
</span></code></pre></div></div> <h2 id="result">Result</h2> <p>The final product is a fully functional, full-size smart traffic light that can display rowing ban status, show animations, and be controlled both manually and remotely.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <iframe src="https://www.youtube.com/embed/0nWFojlPRRk" class="img-fluid rounded z-depth-1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen="" width="auto" height="auto"></iframe> </figure> </div> </div> <div class="caption text-center mt-2"> Video 4: Demo of Party Mode / Random Mode </div> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> <div id="giscus_thread" style="max-width: 930px; margin: 0 auto;"> <script>let giscusTheme=determineComputedTheme(),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"joszuijderwijk/personal-website","data-repo-id":"R_kgDOMbA9Fw","data-category":"Comments","data-category-id":"DIC_kwDOMbA9F84ChjrM","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2024 Jos Zuijderwijk. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?601a2d3465e2a52bec38b600518d5f70"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"About",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"Blog",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"nav-projects",title:"Projects",description:"An overview of projects I&#39;ve been working on.",section:"Navigation",handler:()=>{window.location.href="/projects/"}},{id:"nav-contact",title:"Contact",description:"",section:"Navigation",handler:()=>{window.location.href="/contact/"}},{id:"post-smart-traffic-light-3-full-version",title:"Smart Traffic Light 3: Full version",description:"Building a Full-Size Smart Traffic Light.",section:"Posts",handler:()=>{window.location.href="/blog/traffic-light-3/"}},{id:"post-smart-traffic-light-2-building-the-prototype",title:"Smart Traffic Light 2: Building the Prototype",description:"Creating a miniature internet-enabled traffic light using an ESP-01s microcontroller.",section:"Posts",handler:()=>{window.location.href="/blog/traffic-light-2/"}},{id:"post-smart-traffic-light-1-setting-up-an-iot-system",title:"Smart Traffic Light 1: Setting Up an IoT System",description:"Setting up an IoT network for a smart traffic light.",section:"Posts",handler:()=>{window.location.href="/blog/traffic-light-1/"}},{id:"post-lenker",title:"Lenker",description:"Maakt het internet malser.",section:"Posts",handler:()=>{window.location.href="/blog/lenker/"}},{id:"news-my-new-site-is-online-as-you-can-clearly-see-it-is-still-a-work-in-progress-i-am-planning-to-move-the-content-from-my-old-website-https-old-joszuijderwijk-nl-to-this-site-within-the-coming-weeks",title:"My new site is online! As you can clearly see, it is still...",description:"",section:"News"},{id:"projects-sample-project",title:"Sample project",description:"Just a sample project",section:"Projects",handler:()=>{window.location.href="/projects/first-project/"}},{id:"socials-orcid",title:"ORCID",section:"Socials",handler:()=>{window.open("https://orcid.org/0009-0008-9561-9354","_blank")}},{id:"socials-google-scholar",title:"Google Scholar",section:"Socials",handler:()=>{window.open("https://scholar.google.com/citations?user=f7SM9VYAAAAJ","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/joszuijderwijk","_blank")}},{id:"socials-linkedin",title:"LinkedIn",section:"Socials",handler:()=>{window.open("https://www.linkedin.com/in/joszuijderwijk","_blank")}},{id:"socials-x",title:"X",description:"Twitter",section:"Socials",handler:()=>{window.open("https://twitter.com/joszuijderwijk","_blank")}},{id:"socials-instagram",title:"Instagram",section:"Socials",handler:()=>{window.open("https://instagram.com/joszuijderwijk","_blank")}},{id:"socials-youtube",title:"YouTube",section:"Socials",handler:()=>{window.open("https://youtube.com/@joszuijderwijk919","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Socials",handler:()=>{window.open("/feed.xml","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>