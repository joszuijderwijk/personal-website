<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Smart Traffic Light 2: Building the Prototype | Jos Zuijderwijk </title> <meta name="author" content="Jos Zuijderwijk"> <meta name="description" content="Creating a miniature internet-enabled traffic light using an ESP-01s microcontroller."> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?c754f1480f70868e3d1156aa95244266"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://joszuijderwijk.nl/blog/traffic-light-2/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">
      {
            "title": "Smart Traffic Light 2: Building the Prototype",
            "description": "Creating a miniature internet-enabled traffic light using an ESP-01s microcontroller.",
            "published": "January 27, 2021",
            "authors": [
              
            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Jos</span> Zuijderwijk </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/contact/">Contact </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Smart Traffic Light 2: Building the Prototype</h1> <p>Creating a miniature internet-enabled traffic light using an ESP-01s microcontroller.</p> </d-title> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div> <a href="#hardware">Hardware</a> </div> <div> <a href="#"></a> </div> <ul> <li> <a href="#components">Components</a> </li> <li> <a href="#power">Power</a> </li> <li> <a href="#assembly">Assembly</a> </li> </ul> <div> <a href="#software">Software</a> </div> <div> <a href="#"></a> </div> <ul> <li> <a href="#let-there-be-light">Let there be Light</a> </li> <li> <a href="#wifi">WiFi</a> </li> <li> <a href="#mqtt">MQTT</a> </li> <li> <a href="#user-feedback-animations">User feedback: animations</a> </li> </ul> <div> <a href="#result">Result</a> </div> </nav> </d-contents> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/traffic-light-2-480.webp 480w,/assets/img/traffic-light-2-800.webp 800w,/assets/img/traffic-light-2-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/traffic-light-2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p><a href="https://github.com/joszuijderwijk/smart-traffic-light" rel="external nofollow noopener" target="_blank"><img src="https://img.shields.io/badge/github%20-%20smart--traffic--light-blue?logo=github" alt="Static Badge"></a> <img src="https://img.shields.io/github/stars/joszuijderwijk/smart-traffic-light" alt="Static Badge"></p> <p>Welcome back to our smart traffic light series! In the <a href="../traffic-light-1">previous post</a>, we set up an IoT network. Now, it’s time to bring our concept to life with a miniature internet enabled prototype.</p> <h2 id="hardware">Hardware</h2> <p>In the first part of this blogpost we will focus on the hardware of the project. This project is built around the ESP-01 microcontroller. The ESP-01 is a compact Wi-Fi module based on the ESP8266 chip, designed for IoT projects with built-in Wi-Fi capabilities. Unlike larger Arduino boards which offer more GPIO pins and features, the ESP-01 sacrifices some versatility for an extremely small form factor and lower power consumption, making it ideal for simple, space-constrained IoT applications like our mini traffic light.</p> <h3 id="components">Components</h3> <p>These are the parts I used:</p> <ul> <li>1x <a href="https://nl.aliexpress.com/item/1005006422542411.html" rel="external nofollow noopener" target="_blank">Miniature Traffic Light</a> </li> <li>1x <a href="https://nl.aliexpress.com/item/32948119527.html" rel="external nofollow noopener" target="_blank">ESP-01s</a> </li> <li>1x <a href="https://nl.aliexpress.com/item/1005007333593015.html" rel="external nofollow noopener" target="_blank">Power Cable with Switch</a> </li> <li>1x <a href="https://nl.aliexpress.com/item/32880983608.html" rel="external nofollow noopener" target="_blank">5V to 3.3V Stepdown Converter</a> </li> <li>1x <a href="https://nl.aliexpress.com/item/1780988271.html" rel="external nofollow noopener" target="_blank">Plastic Case (48 * 26 * 15 mm)</a> </li> </ul> <p>In order to program the ESP-01s you also need an <a href="https://nl.aliexpress.com/item/32799975353.html" rel="external nofollow noopener" target="_blank">adapter</a>. It is also possible to use whatever microcontroller with a connection to the internet.</p> <h3 id="power">Power</h3> <p>Our micocontroller runs on 3.3V. Luckily, the LED’s on our miniature traffic light also run without anny hassle on this voltage, so there is no need for resistors. These LED’s can be directly powered by the ESP-01 as they consume very little power.</p> <p>I wanted the whole thing to be powered through a USB cable. Phone chargers and USB ports produce 5V so we need to step that down to 3.3V. I used a small DC-DC buck converter I had lying around. Most converters will be able to do the job, as the whole circuit will only consume ~250mA at max.<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup></p> <h3 id="assembly">Assembly</h3> <p>There it is, fresh from its journey across the seas! This is a common cathode circuit, which means that the shared wire (the black one) has the positive polarity (+3.3V). The GPIOs now function as a <em>sink</em>: when a pin is pulled down to 0V, a current will flow through the LED to the pin. It may be a bit counterintuitive at first, but when we pull a pin LOW, the LED will turn on.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/stoplicht-mini-480.webp 480w,/assets/img/stoplicht-mini-800.webp 800w,/assets/img/stoplicht-mini-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/stoplicht-mini.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Figure 1: Miniature Traffic Light. </div> <p>Assembling our traffic light is straightforward:</p> <ol> <li>Drill a hole in the plastic case for our traffic light and its wires to go through</li> <li>Solder the components onto a piece of perf board, following the wiring diagram in Figure 2</li> </ol> <p>It doesn’t really matter to which of the four GPIO’s (IO0, IO2, RXD, TXD) you connect which LED. This can all be adjusted later programmatically anyway!</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/schematic-stoplicht.svg-480.webp 480w,/assets/img/schematic-stoplicht.svg-800.webp 800w,/assets/img/schematic-stoplicht.svg-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/schematic-stoplicht.svg" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Figure 2: Wiring Diagram. </div> <p>I didn’t make it easy by choosing such a small plastic case. It can be really hard to fit all components in. I used bits of kneading glue to sort of fix the board and the traffic light to the case. Furthermore the traffic light comes with extremely thin wire. You can strip this wire using a soldering iron. It might be hard at first to handle these tiny components.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-2"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/inside-prototype-480.webp 480w,/assets/img/inside-prototype-800.webp 800w,/assets/img/inside-prototype-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/inside-prototype.jpg" class="img-fluid small-img rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Figure 3: Inside the Traffic Light. </div> <p>In the figure above you can see all of the components wired up together. The USB cable in this picture looks a bit loose. That’s the case because I took this photo while repairing that connection.</p> <h2 id="software">Software</h2> <p>Now for the fun part – programming our traffic light! Here’s what we want it to do:</p> <ol> <li>Connect to WiFi</li> <li>Connect to our MQTT server</li> <li>Publish its status in the topic <code class="language-plaintext highlighter-rouge">connection/mini-stoplicht</code> </li> <li>React to changes in <code class="language-plaintext highlighter-rouge">vvb/status</code> </li> <li>Display inbuilt animations</li> </ol> <div class="alert alert-primary" role="alert"> <p><i class="fab fa-github fa-xl"></i> The full source code for driving the miniature traffic light is available on <a href="https://github.com/joszuijderwijk/smart-traffic-light/blob/main/mini_stoplicht.ino" rel="external nofollow noopener" target="_blank">GitHub</a>.</p> </div> <h3 id="control-the-lights">Control the Lights</h3> <p>How to control the lights programmatically? Since we have a common cathode circuit, we’ll have to turn the pins to 0V for our LEDs to turn on. You first have to declare the pins and then set them to OUTPUT to be able to control them. The setup method will be called once upon start.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// According to our wiring diagram</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PIN_RED</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PIN_ORANGE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">int</span> <span class="n">PIN_GREEN</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">setup</span> <span class="p">{</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_GREEN</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_ORANGE</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">PIN_RED</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now turning an LED on or off goes like this:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">digitalWrite</span><span class="p">(</span><span class="n">PIN_RED</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>    <span class="c1">// Turn ON</span>
<span class="n">digitalWrite</span><span class="p">(</span><span class="n">PIN_RED</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>   <span class="c1">// Turn OFF</span>
</code></pre></div></div> <h3 id="wifi">WiFi</h3> <p>We want our traffic light to work anywhere, so hard-coding WiFi credentials is a no-go. Luckily, there exists a library to handle this exact problem: <a href="https://github.com/tzapu/WiFiManager" rel="external nofollow noopener" target="_blank">WiFiManager</a>. That works with the standard <a href="https://github.com/esp8266/Arduino/tree/master/libraries/ESP8266WiFi" rel="external nofollow noopener" target="_blank">ESP8266WiFi library</a>. This neat library creates an access point with a captive portal, allowing users to select their network (see Figure 4). It’s like giving your traffic light its own tiny smartphone setup screen! If you add your details, those are saved into PROGMEM. So even if you restart your device, it will still remember your SSID/password.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-2"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/captive_portal-480.webp 480w,/assets/img/captive_portal-800.webp 800w,/assets/img/captive_portal-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/captive_portal.jpeg" class="img-fluid small-img rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Figure 4: Captive Portal. </div> <p>The library also makes it easy to add custom HTML. I added a custom footer that contains my contact information.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">WiFiManager</span> <span class="n">wifiManager</span><span class="p">;</span>
  <span class="n">WiFiManagerParameter</span> <span class="nf">custom_text</span><span class="p">(</span><span class="s">"&lt;p&gt;(c) 2019 by &lt;a href=</span><span class="se">\"</span><span class="s">mailto:...</span><span class="se">\"</span><span class="s">&gt;Jos Zuijderwijk&lt;/a&gt;&lt;/p&gt;"</span><span class="p">);</span>
  <span class="n">wifiManager</span><span class="p">.</span><span class="n">addParameter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">custom_text</span><span class="p">);</span>
</code></pre></div></div> <h3 id="mqtt">MQTT</h3> <p>For the MQTT connection I used the <a href="https://github.com/knolleary/pubsubclient" rel="external nofollow noopener" target="_blank">PubSubClient library</a>. You just provide your MQTT details (host, user, password, port) and this library will do the rest. This piece of code connects to the broker, and takes a so-called <em>will message</em>. This message will be sent to the broker if the device suddenly disconnects. The will message I provided is a <strong>retained</strong> ”0” in topic <code class="language-plaintext highlighter-rouge">connection/mini-stoplicht</code>. After first connecting the client will publish a retained “1” in the same topic. This way we can easily see if the device is connected or not. I also let the client subscribe to the <code class="language-plaintext highlighter-rouge">vvb/status</code> topic. That’s the channel the commands will be sent to.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">WiFiClient</span> <span class="n">wifiClient</span><span class="p">;</span>               <span class="c1">// WiFi</span>
<span class="n">PubSubClient</span> <span class="nf">client</span><span class="p">(</span><span class="n">wifiClient</span><span class="p">);</span>     <span class="c1">// MQTT</span>
    
<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">mqtt_client_name</span><span class="p">,</span> <span class="n">mqtt_username</span><span class="p">,</span> <span class="n">mqtt_password</span><span class="p">,</span> <span class="s">"connection/mini-stoplicht"</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">"0"</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// Send Hello World!</span>
      <span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="s">"connection/mini-stoplicht"</span><span class="p">,</span> <span class="s">"1"</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s">"vvb/status"</span><span class="p">);</span> 
<span class="p">}</span>
</code></pre></div></div> <p>The MQTT callback function, that is the function that is called whenever a message is published to a topic that the client has subscribed to, looks like this.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">callback</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">topic</span><span class="p">,</span> <span class="n">byte</span><span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span> <span class="c1">// payload</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">msg</span> <span class="o">+=</span> <span class="p">((</span><span class="kt">char</span><span class="p">)</span><span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="s">"vvb/status"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">){</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="s">"0"</span><span class="p">){</span>
      <span class="n">updateLights</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="s">"1"</span><span class="p">){</span>
      <span class="n">updateLights</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">==</span> <span class="s">"2"</span><span class="p">){</span>
      <span class="n">updateLights</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="p">}</span>  
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>This will check if the topic name equals to the value we expect (more useful when subscribed to more than one topic). Then it will set the lights using the helper function <code class="language-plaintext highlighter-rouge">updateLights</code>, according to the received value. This function takes three booleans, each representing an LED of the traffic light that is either on or off.</p> <h3 id="user-feedback-animations">User feedback: animations</h3> <p>Now the device basically does what we need. But it’s not user friendly yet. How is a user going to know if the traffic light is not able to connect to the WiFi network? Okay, someone could check if the captive portal is up, but there is no visual indication.</p> <p>One way to solve this is adding animations. If the traffic light is connecting to the WiFi network I want it to go from green-orange-red every 500 milliseconds. If the traffic light has failed to connect, I want the red light to blink every second. The easiest way to implement this is using a <em>Ticker</em>, which is a standard <a href="https://www.arduino.cc/reference/en/libraries/ticker/" rel="external nofollow noopener" target="_blank">library</a> for Arduino. A Ticker executes a given method repeatedly without using the blocking <code class="language-plaintext highlighter-rouge">delay()</code> function.</p> <p>I implemented the animations like this:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">animationCycle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// connecting to wifi animation</span>
<span class="kt">void</span> <span class="nf">startupAnimation</span><span class="p">(){</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">animationCycle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
      <span class="n">updateLights</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
      <span class="n">animationCycle</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">animationCycle</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
      <span class="n">updateLights</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
      <span class="n">animationCycle</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">animationCycle</span> <span class="o">==</span> <span class="mi">2</span><span class="p">){</span>
      <span class="n">updateLights</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
      <span class="n">animationCycle</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">animationCycle</span> <span class="o">==</span> <span class="mi">3</span><span class="p">){</span>
      <span class="n">updateLights</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
      <span class="n">animationCycle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// access point animation</span>
<span class="kt">void</span> <span class="nf">apAnimation</span><span class="p">(){</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">animationCycle</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
    <span class="n">updateLights</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="n">animationCycle</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="n">updateLights</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="n">animationCycle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>We then can attach the animation functions to the ticker with a certain interval so it gets called repeatedly.</p> <h2 id="result">Result</h2> <p>The traffic light responds perfectly to the MQTT messages that are sent in the <code class="language-plaintext highlighter-rouge">vvb/status</code> topic. You can easily test that using software like <a href="https://mqtt-explorer.com//" rel="external nofollow noopener" target="_blank">MQTT Explorer</a>. In Figure 5 you will see the animation for “there is no internet connection, an access point has been made” and “trying to connect”.</p> <p>A future improvement could be switching to an encrypted MQTT connection.</p> <p>In the <a href="../traffic-light-3">next and final post</a> we will create a full-fledged internet controlled traffic light.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/animation-1-480.webp 480w,/assets/img/animation-1-800.webp 800w,/assets/img/animation-1-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/animation-1.gif" class="img-fluid small-img rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <div class="caption"> "WiFi Not Found" Animation </div> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/animation-2-480.webp 480w,/assets/img/animation-2-800.webp 800w,/assets/img/animation-2-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/animation-2.gif" class="img-fluid small-img rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <div class="caption"> "Connecting" Animation </div> </div> </div> <div class="caption"> Figure 5: Animations </div> <hr> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1" role="doc-endnote"> <p>The ESP-01 consumes 200mA at maximum power (e.g. while connecting to the internet) according to the datasheet and a typical LED consumes around 20mA. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> <div id="giscus_thread" style="max-width: 930px; margin: 0 auto;"> <script>let giscusTheme=determineComputedTheme(),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"joszuijderwijk/personal-website","data-repo-id":"R_kgDOMbA9Fw","data-category":"Comments","data-category-id":"DIC_kwDOMbA9F84ChjrM","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,e])=>giscusScript.setAttribute(t,e)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2024 Jos Zuijderwijk. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?601a2d3465e2a52bec38b600518d5f70"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"About",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-blog",title:"Blog",description:"",section:"Navigation",handler:()=>{window.location.href="/blog/"}},{id:"nav-projects",title:"Projects",description:"An overview of projects I&#39;ve been working on.",section:"Navigation",handler:()=>{window.location.href="/projects/"}},{id:"nav-contact",title:"Contact",description:"",section:"Navigation",handler:()=>{window.location.href="/contact/"}},{id:"post-smart-traffic-light-3-full-version",title:"Smart Traffic Light 3: Full version",description:"Building a Full-Size Smart Traffic Light.",section:"Posts",handler:()=>{window.location.href="/blog/traffic-light-3/"}},{id:"post-smart-traffic-light-2-building-the-prototype",title:"Smart Traffic Light 2: Building the Prototype",description:"Creating a miniature internet-enabled traffic light using an ESP-01s microcontroller.",section:"Posts",handler:()=>{window.location.href="/blog/traffic-light-2/"}},{id:"post-smart-traffic-light-1-setting-up-an-iot-system",title:"Smart Traffic Light 1: Setting Up an IoT System",description:"Setting up an IoT network for a smart traffic light.",section:"Posts",handler:()=>{window.location.href="/blog/traffic-light-1/"}},{id:"post-lenker",title:"Lenker",description:"Maakt het internet malser.",section:"Posts",handler:()=>{window.location.href="/blog/lenker/"}},{id:"news-my-new-site-is-online-as-you-can-clearly-see-it-is-still-a-work-in-progress-i-am-planning-to-move-the-content-from-my-old-website-https-old-joszuijderwijk-nl-to-this-site-within-the-coming-weeks",title:"My new site is online! As you can clearly see, it is still...",description:"",section:"News"},{id:"projects-sample-project",title:"Sample project",description:"Just a sample project",section:"Projects",handler:()=>{window.location.href="/projects/first-project/"}},{id:"socials-orcid",title:"ORCID",section:"Socials",handler:()=>{window.open("https://orcid.org/0009-0008-9561-9354","_blank")}},{id:"socials-google-scholar",title:"Google Scholar",section:"Socials",handler:()=>{window.open("https://scholar.google.com/citations?user=f7SM9VYAAAAJ","_blank")}},{id:"socials-github",title:"GitHub",section:"Socials",handler:()=>{window.open("https://github.com/joszuijderwijk","_blank")}},{id:"socials-linkedin",title:"LinkedIn",section:"Socials",handler:()=>{window.open("https://www.linkedin.com/in/joszuijderwijk","_blank")}},{id:"socials-x",title:"X",description:"Twitter",section:"Socials",handler:()=>{window.open("https://twitter.com/joszuijderwijk","_blank")}},{id:"socials-instagram",title:"Instagram",section:"Socials",handler:()=>{window.open("https://instagram.com/joszuijderwijk","_blank")}},{id:"socials-youtube",title:"YouTube",section:"Socials",handler:()=>{window.open("https://youtube.com/@joszuijderwijk919","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Socials",handler:()=>{window.open("/feed.xml","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>